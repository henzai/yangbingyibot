name: Docs Sync

on:
  pull_request:
    types: [closed]
    paths:
      - "src/clients/**"
      - "src/workflows/**"
      - "src/utils/**"
      - "src/middleware/**"
      - "src/responses/**"
      - "wrangler.toml"
      - "src/types.ts"
      - "src/index.ts"

jobs:
  sync-docs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Sync CLAUDE.md with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: '--model claude-opus-4-6 --max-turns 30 --allowedTools "Read,Glob,Grep,Write,Edit,Bash(git:*),Bash(gh pr:*)"'
          prompt: |
            You are a documentation sync assistant. A PR has just been merged, and you need to verify that CLAUDE.md is still accurate and up-to-date.

            ## Context

            - **Merged PR**: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            - **Author**: ${{ github.event.pull_request.user.login }}
            - **Base SHA**: ${{ github.event.pull_request.base.sha }}
            - **Head SHA**: ${{ github.event.pull_request.head.sha }}

            ## Instructions

            ### Step 1: Analyze the PR changes

            Run `git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}` to understand what was changed in this PR.

            ### Step 2: Read and verify CLAUDE.md

            Read CLAUDE.md and verify the accuracy of the following sections by comparing them against the actual codebase:

            1. **Architecture** - Verify the request flow and caching strategy descriptions match the actual implementation
            2. **Project Structure** - Verify all listed files/directories exist and descriptions are accurate. Check for new files/directories that should be listed
            3. **Environment Variables** - Verify all environment variables and bindings match wrangler.toml and the codebase
            4. **Development Commands** - Verify all scripts listed match package.json

            IMPORTANT: Check not only for changes caused by this PR, but also fix any pre-existing inaccuracies you find.

            ### Step 3: Take action

            **If CLAUDE.md needs updates:**

            1. Create a new branch from the current HEAD:
               ```
               git checkout -b docs/sync-from-pr-${{ github.event.pull_request.number }}
               ```
            2. Update CLAUDE.md with the necessary changes (ONLY modify CLAUDE.md)
            3. Commit the changes:
               ```
               git add CLAUDE.md
               git commit -m "docs: sync CLAUDE.md after PR #${{ github.event.pull_request.number }}"
               ```
            4. Push the branch:
               ```
               git push origin docs/sync-from-pr-${{ github.event.pull_request.number }}
               ```
            5. Create a draft PR:
               ```
               gh pr create --draft \
                 --title "docs: sync CLAUDE.md after PR #${{ github.event.pull_request.number }}" \
                 --body "## Summary

               CLAUDE.md の内容を PR #${{ github.event.pull_request.number }} (${{ github.event.pull_request.title }}) のマージ後の実コードと同期します。

               ## Changes

               <list the specific changes made to CLAUDE.md>

               ---
               Auto-generated by docs-sync workflow."
               ```

            **If CLAUDE.md is already accurate:**

            Post a comment on the original PR:
            ```
            gh pr comment ${{ github.event.pull_request.number }} --body "✅ CLAUDE.md の検証が完了しました。更新は不要です。"
            ```
