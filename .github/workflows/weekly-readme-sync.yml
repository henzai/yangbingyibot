name: Weekly README Sync

on:
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9:00 UTC (18:00 JST)
  workflow_dispatch:

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Refine README.md with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: '--model claude-opus-4-6 --max-turns 30 --allowedTools "Read,Glob,Grep,Write,Edit,Bash(git:*),Bash(gh pr:*)"'
          prompt: |
            You are a documentation refinement assistant. Your job is to review and refine README.md to ensure it accurately reflects the current state of the codebase.

            ## Instructions

            ### Step 1: Analyze the current codebase

            Thoroughly examine the codebase to understand:
            - Project structure (all files and directories under src/, scripts/, etc.)
            - package.json scripts and dependencies
            - wrangler.toml bindings and configuration
            - Key features and architecture patterns
            - Any recent changes since the README was last updated

            ### Step 2: Read and evaluate README.md

            Read README.md and evaluate the following aspects:

            1. **Accuracy** - Does every section match the actual codebase? Check:
               - Feature descriptions match implemented functionality
               - Architecture diagram matches actual request flow
               - Setup instructions are correct and complete
               - Development commands match package.json scripts
               - Project structure matches actual files and directories
               - Technology stack lists all major dependencies

            2. **Completeness** - Is anything missing?
               - New features or capabilities not yet documented
               - New files or directories not reflected in the structure
               - New environment variables or bindings
               - New scripts or commands

            3. **Clarity** - Can the documentation be improved?
               - Are descriptions clear and concise?
               - Is the information well-organized?
               - Are there any outdated or misleading descriptions?

            ### Step 3: Take action

            **If README.md needs updates:**

            1. Create a new branch from the current HEAD:
               ```
               git checkout -b docs/weekly-readme-sync-$(date +%Y%m%d)
               ```
            2. Update README.md with the necessary changes
               - Maintain the existing Japanese language style
               - Keep the same overall structure unless reorganization is clearly needed
               - Only make meaningful improvements, not cosmetic changes
            3. Commit the changes:
               ```
               git add README.md
               git commit -m "docs: refine README.md (weekly sync)"
               ```
            4. Push the branch:
               ```
               git push origin docs/weekly-readme-sync-$(date +%Y%m%d)
               ```
            5. Create a draft PR:
               ```
               gh pr create --draft \
                 --title "docs: refine README.md (weekly sync)" \
                 --body "## Summary

               README.md の内容を現在のコードベースと同期し、改善します。

               ## Changes

               <list the specific changes made to README.md>

               ---
               Auto-generated by weekly-readme-sync workflow."
               ```

            **If README.md is already accurate and complete:**

            Do nothing. No PR or comment is needed.
