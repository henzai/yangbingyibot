name: Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    # Skip bot-created issues and issues containing @claude (handled by claude.yml)
    if: |
      !contains(github.event.issue.user.login, '[bot]') &&
      !contains(github.event.issue.body, '@claude') &&
      !contains(github.event.issue.title, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          token: ${{ secrets.PAT_TOKEN }}

      - name: Triage Issue with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: '--model claude-opus-4-6 --max-turns 30 --allowedTools "Read,Glob,Grep,Write,Edit,Bash(gh issue:*),Bash(gh search:*),Bash(gh pr:*),Bash(gh label:*),Bash(git:*),Bash(npm run check),Bash(npm test)"'
          prompt: |
            You are an AI issue triage assistant for this repository. Analyze the newly opened issue and perform a comprehensive triage.

            ## Issue Details
            - **Title**: ${{ github.event.issue.title }}
            - **Body**: ${{ github.event.issue.body }}
            - **Author**: ${{ github.event.issue.user.login }}
            - **Issue Number**: ${{ github.event.issue.number }}

            ## Triage Steps

            Follow these 7 steps in order:

            ### Step 1: Input Validation & Spam Detection
            - If the issue body is empty or has very little substance (less than ~10 meaningful words), add the `needs-info` label and post a comment asking for more details, then stop.
            - If the issue appears to be spam (ads, random text, unrelated content), close it with a comment explaining why, then stop.

            ### Step 2: Language Detection
            - Detect the language of the issue body (Japanese or English).
            - Respond in the SAME language as the issue throughout all comments.

            ### Step 3: Smart Label Classification
            Analyze the issue content and apply labels from these 3 categories:

            **Type** (pick one):
            - `bug` (color: `d73a4a`, description: "Something isn't working")
            - `feature` (color: `a2eeef`, description: "New feature request")
            - `enhancement` (color: `84b6eb`, description: "Improvement to existing feature")
            - `question` (color: `d876e3`, description: "Question about the project")
            - `documentation` (color: `0075ca`, description: "Documentation improvement")

            **Area** (pick one or more):
            - `area:discord` (color: `5865F2`, description: "Discord integration")
            - `area:gemini` (color: `4285F4`, description: "Gemini AI integration")
            - `area:sheets` (color: `0F9D58`, description: "Google Sheets integration")
            - `area:workflow` (color: `F4B400`, description: "Cloudflare Workflow")
            - `area:ci` (color: `333333`, description: "CI/CD and GitHub Actions")

            **Priority** (pick one):
            - `priority:critical` (color: `b60205`, description: "Needs immediate attention")
            - `priority:high` (color: `d93f0b`, description: "Important, should be addressed soon")
            - `priority:medium` (color: `fbca04`, description: "Normal priority")
            - `priority:low` (color: `0e8a16`, description: "Nice to have, low urgency")

            For each label, create it if it doesn't exist:
            ```
            gh label create "<label-name>" --color "<color>" --description "<description>" --force
            ```

            Then apply all selected labels at once:
            ```
            gh issue edit <issue-number> --add-label "label1,label2,label3"
            ```

            ### Step 4: Codebase Analysis
            - Use Grep and Glob to find code files related to the issue.
            - Read the relevant files to understand the current implementation.
            - Identify the specific files, functions, and line numbers that are relevant.
            - Assess the impact and scope of the issue.

            ### Step 5: Duplicate Issue Detection
            - Search for potentially related existing issues:
            ```
            gh search issues "<key terms>" --repo ${{ github.repository }} --state open --limit 10
            gh search issues "<key terms>" --repo ${{ github.repository }} --state closed --limit 5
            ```
            - If a clear duplicate is found, add the `duplicate` label and reference the original issue.

            ### Step 6: Post Triage Comment
            Post a structured triage comment on the issue with the following format:

            ```markdown
            ## Triage Summary

            | Category | Value |
            |----------|-------|
            | Type | `<type>` |
            | Priority | `<priority>` |
            | Area | `<area(s)>` |
            | Complexity | `<S/M/L/XL>` |

            ## Analysis

            <Brief analysis of the issue - what it means, its impact, and context>

            ## Related Code

            | File | Lines | Description |
            |------|-------|-------------|
            | `<file-path>` | L<start>-L<end> | <what this code does> |
            | ... | ... | ... |

            ## <"Root Cause Hypothesis" for bugs OR "Implementation Approach" for features>

            <Detailed analysis or proposal>

            ## Complexity Estimate

            - **Effort**: <estimated effort>
            - **Files to change**: <number>
            - **Risk**: <Low/Medium/High - explanation>

            ## Related Issues

            - #<number> - <title> (<relationship>)
            ```

            Adapt the sections based on the issue type (bug vs feature vs question etc).

            ### Step 7: Auto-fix PR (Conditional)
            ONLY attempt this if ALL conditions are met:
            - The issue type is `bug` or `enhancement`
            - The fix is obviously simple (2 files or fewer, ~20 lines or fewer)
            - You have 90%+ confidence in the fix
            - The fix won't break existing functionality

            If conditions are met:
            1. Create a new branch: `git checkout -b fix/issue-<number>`
            2. Make the fix
            3. Run `npm run check` to verify formatting/linting
            4. Run `npm test` to verify tests pass
            5. If both pass, commit and push, then create a draft PR:
               ```
               gh pr create --draft --title "Fix: <short description>" --body "Fixes #<number>\n\n<description of changes>"
               ```
            6. If checks fail, discard changes and note in the triage comment that auto-fix was attempted but could not be completed.

            If conditions are NOT met, skip this step entirely (this is expected for most issues).
